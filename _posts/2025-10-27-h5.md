---
title: 关键渲染路径
tags: 
article_header:
  type: cover
excerpt_separator: <!--more-->
---

## 1 关键渲染路径的核心概念

### 1.1 定义与意义

**关键渲染路径（Critical Rendering Path）** 是浏览器从接收到 HTML、CSS、JavaScript 字节开始，到最终把像素绘制到屏幕上的整个过程。
它决定了用户首次看到页面内容（尤其是关键信息）的时间，因此优化这条路径能显著提升用户的主观加载体验。

**核心目标：**

* 尽快展示与用户操作相关的内容；
* 减少阻塞渲染的资源和依赖；
* 优化感知性能，让“页面变快”。

---

## 2 浏览器渲染的五个关键阶段

### 2.1 DOM 构建

HTML → 字节 → 字符 → 令牌（Token）→ 节点（Node）→ **DOM 树**

* 浏览器解析 HTML 文档时顺序构建 DOM。
* 节点关系按标签嵌套层次形成父子树。

### 2.2 CSSOM 构建

CSS → 字节 → 字符 → 令牌 → 节点 → **CSSOM 树**

* 遇到 `<link>` 外部样式表会发出请求。
* **CSS 是阻塞渲染的资源**，必须构建完成 CSSOM 才能绘制页面。

### 2.3 合并生成渲染树（Render Tree）

**渲染树 = DOM + CSSOM**

* 仅包含可见节点（如 `display:none` 不会进入）。
* 每个节点应用样式后得到可见元素信息。

### 2.4 布局（Layout）

确定每个元素在视口（Viewport）中的 **位置和尺寸**，输出盒模型。

### 2.5 绘制（Paint）

浏览器将渲染树的结果转换为屏幕像素。
若 DOM 或 CSSOM 变化，则需重新执行上述步骤。

---

## 3 JavaScript 在关键路径中的影响

### 3.1 执行时机

* HTML 解析到 `<script>` 时会**暂停 DOM 构建**，执行完再继续。
* 外部脚本还需等待网络请求返回。

### 3.2 阻塞原因

* JS 可以读取/修改 DOM 和 CSSOM，因此浏览器必须确保两者构建状态一致。
* 如果同时存在 `<link>` 和 `<script>`，样式加载未完成会阻止脚本执行，脚本执行又会阻止 DOM 继续构建。

### 3.3 结论

JavaScript 与 CSS 都是阻塞渲染的资源，处理不当会显著延迟首次绘制。

---

## 4 性能指标与分析

| 指标                               | 含义            |
| -------------------------------- | ------------- |
| **First Paint (FP)**             | 浏览器首次绘制像素的时间  |
| **First Meaningful Paint (FMP)** | 用户首次看到有用内容的时间 |
| **DOMContentLoaded (DCL)**       | DOM 构建完成      |
| **Load**                         | 所有资源加载完毕      |

优秀网站会将 **FMP 控制在 1 秒内**，否则需要重新审视关键渲染路径。

---

## 5 关键渲染路径优化策略

### 5.1 分析与关注点

关注三个核心维度：

1. **关键资源数量**
2. **关键资源大小**
3. **往返次数（Roundtrip）**

目标：**减少数量、减小体积、减少往返。**

---

## 6 优化手段

### 6.1 减少关键资源大小

* 对 HTML / CSS / JS / 图片 进行 **Minify、压缩、缓存（Cache）**。
* HTML 为关键资源，应尽量删除注释和冗余代码。

### 6.2 延迟或异步加载 JavaScript

```html
<script src="script.js"></script>          <!-- 阻塞 -->
<script async src="script.js"></script>    <!-- 异步 -->
<script defer src="script.js"></script>    <!-- 延迟执行 -->
```

* **async**：立即并行下载并在加载完后立刻执行，不等 HTML 解析。
* **defer**：并行下载，HTML 解析完成后统一执行。
* 将非关键 JS 放在 `</body>` 前或使用延迟执行机制。

### 6.3 尽早加载关键 CSS

* 将 `<link>` 放在 `<head>` 顶部，加快 CSS 请求。
* 使用 `media` 属性为响应式样式分离加载。
* 避免 `@import`（增加额外请求）。

### 6.4 内联关键 CSS

* 将首屏渲染所需的关键 CSS **内联进 HTML `<head>`**。
* 完整样式异步加载，确保用户尽快看到“above-the-fold”内容。

### 6.5 控制关键资源在 14KB 以内

TCP 的慢启动特性决定了首个数据包窗口约为 **14KB**，若关键资源 ≤14KB，可在首个往返内加载完成。

---

## 7 其他资源与关键路径关系

| 资源类型                     | 是否阻塞渲染 | 说明                    |
| ------------------------ | ------ | --------------------- |
| 图片                       | 否      | 加载过程中逐步显示，不影响首次绘制     |
| 字体（Web Font / Icon Font） | 可能     | 字体加载延迟会导致“无文字闪烁”或延迟绘制 |

---

## 8 总结

**优化关键渲染路径的核心目标：**

> 让用户“尽快看到有用的内容”。

### 实践要点

1. 优先显示用户关注区域（感知性能 > 绝对速度）
2. 减少阻塞渲染资源数量与依赖
3. 尽早加载关键 CSS、延迟加载 JS
4. 利用内联与缓存减少网络往返
5. 用性能分析工具（Chrome Performance）持续验证 FMP、Load 时机

简而言之，**关键渲染路径优化** 是“让浏览器尽快把最重要的像素绘制到屏幕上”的系统工程，它既是技术优化，也直接决定了用户对网站的第一印象与信任感。
